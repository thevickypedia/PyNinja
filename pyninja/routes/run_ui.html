<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>PyNinja - Command Runner</title>
        <meta property="og:type" content="CommandRunner">
        <meta name="keywords" content="Python, Monitor, fastapi, JavaScript, HTML, CSS">
        <meta name="author" content="Vignesh Rao">
        <!-- Favicon.ico and Apple Touch Icon -->
        <link property="og:image" rel="icon" href="https://thevickypedia.github.io/open-source/images/logo/pyninja.ico">
        <link property="og:image" rel="apple-touch-icon"
            href="https://thevickypedia.github.io/open-source/images/logo/pyninja.png">
        <meta content="width=device-width, initial-scale=1" name="viewport">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                font-family: "Segoe UI", sans-serif;
                padding: 40px;
                background: #f7f9fc;
                color: #333;
            }

            h2 {
                margin-top: 40px;
                color: #222;
            }

            .input-group {
                position: relative;
                margin-top: 25px;
            }

            .input-group input,
            .input-group textarea {
                width: 100%;
                padding: 12px 12px 12px 12px;
                border: 1px solid #ccc;
                border-radius: 6px;
                background: white;
                font-size: 16px;
                outline: none;
                transition: all 0.2s ease;
            }

            .input-group textarea {
                resize: vertical;
                min-height: 60px;
            }

            .input-group label {
                position: absolute;
                top: 12px;
                left: 12px;
                font-size: 16px;
                color: #777;
                pointer-events: none;
                transition: 0.2s ease all;
                background: white;
                padding: 0 4px;
            }

            .input-group input:focus + label,
            .input-group input:not(:placeholder-shown) + label,
            .input-group textarea:focus + label,
            .input-group textarea:not(:placeholder-shown) + label {
                top: -10px;
                left: 10px;
                font-size: 12px;
                color: #555;
            }

            button {
                margin-top: 25px;
                padding: 12px;
                width: 100%;
                background: #2a73ff;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                transition: background 0.2s ease;
            }

            button:hover {
                background: #1d5ee8;
            }

            .main-container {
                max-width: 600px;
                margin: auto;
            }

            #log-output {
                margin-top: 30px;
                min-height: 300px;
                width: 80%;
                overflow: auto;
                background: #1e1e1e;
                color: #00ff8c;
                padding: 15px;
                font-family: monospace;
                white-space: pre-wrap;
                border-radius: 6px;
                border: 1px solid #444;
                resize: both;
                box-sizing: border-box;

                display: none;

                /* Align with centered content */
                margin-left: auto;
                margin-right: auto;
            }

            #export-log {
                width: 30%;
                max-width: 200px;
                padding: 10px;
                margin: 5px auto;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                display: block;
            }

            #stop-streaming,
            #clear-console {
                width: 30%;
                max-width: 200px;
                padding: 10px;
                margin: 5px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #stop-streaming {
                background: #ff4c4c;
                color: white;
            }

            #clear-console {
                background: #888;
                color: white;
            }

            .hidden {
                display: none !important;
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <div id="credentials-section">
                <h2>API Credentials</h2>
                <div class="input-group">
                    <input id="apikey" type="text" required placeholder=" " />
                    <label for="apikey">API Key (required)</label>
                </div>

                <div class="input-group">
                    <input id="apisecret" type="password" required placeholder=" " />
                    <label for="apisecret">API Secret (required)</label>
                </div>

                <div class="input-group">
                    <input id="mfa_token" type="text" placeholder=" " />
                    <label for="mfa_token">MFA Token (required)</label>
                </div>

                <button id="save-creds">Save and Continue</button>
            </div>
            <button id="clear-creds" style="background: #bbb; margin-top: 10px;">Clear Credentials (Logout)</button>

            <div id="command-section" class="hidden">
                <h2>Run Command</h2>
                <div class="input-group">
                    <textarea id="command" placeholder=" "></textarea>
                    <label for="command">Enter command</label>
                </div>

                <div class="input-group">
                    <input id="timeout" type="number" placeholder=" " />
                    <label for="timeout">Timeout (seconds)</label>
                </div>
                <button id="run-command">Run</button>
            </div>
        </div>
        <div id="log-output"></div>
        <div id="streaming-status" class="hidden" style="margin-top: 10px; text-align: center;"><span style="color: green;">‚óè</span> <span>Streaming...</span></div>
        <button id="export-log" class="hidden" style="background: #4caf50;">Download Log</button>
        <div style="text-align: center; margin-top: 10px;">
            <button id="stop-streaming" class="hidden">Stop Streaming</button>
            <button id="clear-console" class="hidden">Clear Console</button>
        </div>
    </body>
    <script>
        const clearCredsButton = document.getElementById("clear-creds");
        const saveButton = document.getElementById("save-creds");
        const runButton = document.getElementById("run-command");
        const commandSection = document.getElementById("command-section");
        const credentialsSection = document.getElementById("credentials-section");
        const logOutput = document.getElementById("log-output");
        const stopButton = document.getElementById("stop-streaming");
        const clearButton = document.getElementById("clear-console");
        const exportButton = document.getElementById("export-log");

        let currentAbortController = null;
        let wasManuallyStopped = false;

        function toggleClearCredsButton() {
            const hasCreds = localStorage.getItem("apikey") && localStorage.getItem("apisecret") && localStorage.getItem("mfa_token");
            clearCredsButton.style.display = hasCreds ? "block" : "none";
        }

        function showLogOutput(show) {
            logOutput.style.display = show ? "block" : "none";
            exportButton.classList.toggle("hidden", !show);
        }

        window.addEventListener("DOMContentLoaded", () => {
            const apikey = localStorage.getItem("apikey");
            const apisecret = localStorage.getItem("apisecret");
            const mfa_token = localStorage.getItem("mfa_token");

            if (apikey && apisecret && mfa_token) {
                document.getElementById("apikey").value = apikey;
                document.getElementById("apisecret").value = apisecret;
                document.getElementById("mfa_token").value = mfa_token || "";

                // Auto-show command section if all credentials exist
                commandSection.classList.remove("hidden");
            }
            // Hide download log button initially because console is not visible yet
            exportButton.classList.add("hidden");
            toggleClearCredsButton();
        });

        clearCredsButton.addEventListener("click", () => {
            localStorage.removeItem("apikey");
            localStorage.removeItem("apisecret");
            localStorage.removeItem("mfa_token");

            document.getElementById("apikey").value = "";
            document.getElementById("apisecret").value = "";
            document.getElementById("mfa_token").value = "";

            // Show the credentials section again
            document.getElementById("credentials-section").style.display = "block";

            // Hide command section and related buttons
            document.getElementById("command-section").classList.add("hidden");
            showLogOutput(false);
            clearCredsButton.style.display = "none";
        });

        saveButton.addEventListener("click", () => {
            const apikey = document.getElementById("apikey").value.trim();
            const apisecret = document.getElementById("apisecret").value.trim();
            const mfa_token = document.getElementById("mfa_token").value.trim();

            if (!apikey || !apisecret || !mfa_token) {
                alert("API Key, API Secret, and MFA Token are required.");
                return;
            }

            localStorage.setItem("apikey", apikey);
            localStorage.setItem("apisecret", apisecret);
            localStorage.setItem("mfa_token", mfa_token);

            commandSection.classList.remove("hidden");
            toggleClearCredsButton();
        });

        runButton.addEventListener("click", async () => {
            const command = document.getElementById("command").value.trim();
            const timeout = parseInt(document.getElementById("timeout").value.trim(), 10);

            if (!command || isNaN(timeout)) {
                alert("Please enter both command and timeout.");
                return;
            }

            const apikey = localStorage.getItem("apikey");
            const apisecret = localStorage.getItem("apisecret");
            const mfa_token = localStorage.getItem("mfa_token");

            logOutput.textContent = "Streaming output...\n";
            showLogOutput(true);
            credentialsSection.style.display = "none";
            stopButton.classList.remove("hidden");
            clearButton.classList.add("hidden");
            document.getElementById("streaming-status").classList.remove("hidden");

            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            const hardTimeout = setTimeout(() => {
                currentAbortController?.abort();
            }, 15000); // 15 seconds

            try {
                const response = await fetch(`${window.location.origin}{{ API_ENDPOINT }}`, {
                    method: "POST",
                    headers: {
                        accept: "application/json",
                        "api-secret": apisecret,
                        "mfa-code": mfa_token,
                        Authorization: `Bearer ${apikey}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        command: command,
                        timeout: timeout,
                        stream: true,
                    }),
                    signal,
                });

                clearTimeout(hardTimeout);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error: ${response.status} - ${errorText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    logOutput.textContent += chunk;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }

                // Streaming complete
                stopButton.classList.add("hidden");
                clearButton.classList.remove("hidden");
                document.getElementById("streaming-status").classList.add("hidden");
            } catch (err) {
                clearTimeout(hardTimeout);
                stopButton.classList.add("hidden");
                currentAbortController = null;
                document.getElementById("streaming-status").classList.add("hidden");

                if (wasManuallyStopped) {
                    wasManuallyStopped = false;
                    clearButton.classList.remove("hidden");
                    return;
                }

                alert("Network or server error: " + err.message);
                showLogOutput(false);
                credentialsSection.style.display = "block";
                clearButton.classList.add("hidden");
            }
        });

        stopButton.addEventListener("click", () => {
            if (currentAbortController) {
                wasManuallyStopped = true;
                currentAbortController.abort();
                currentAbortController = null;
            }

            stopButton.classList.add("hidden");
            clearButton.classList.remove("hidden");
        });

        clearButton.addEventListener("click", () => {
            logOutput.textContent = "";
            clearButton.classList.add("hidden");
            showLogOutput(false);
        });

        exportButton.addEventListener("click", () => {
            const now = new Date();
            // Format: MMDDYYYY_HHmmUTC (e.g. 08192025_1754UTC)
            const pad = (num) => String(num).padStart(2, "0");
            const timestamp = pad(now.getMonth() + 1) + pad(now.getDate()) + now.getFullYear() + "_" + pad(now.getHours()) + pad(now.getMinutes()) + "UTC";

            const filename = `command-log_${timestamp}.txt`;
            const blob = new Blob([logOutput.textContent], { type: "text/plain" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    </script>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Command Runner</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 40px;
            background: #f7f9fc;
            color: #333;
            max-width: 600px;
            margin: auto;
        }

        h2 {
            margin-top: 40px;
            color: #222;
        }

        .input-group {
            position: relative;
            margin-top: 25px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 12px 12px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
            font-size: 16px;
            outline: none;
            transition: all 0.2s ease;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .input-group label {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            color: #777;
            pointer-events: none;
            transition: 0.2s ease all;
            background: white;
            padding: 0 4px;
        }

        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label,
        .input-group textarea:focus + label,
        .input-group textarea:not(:placeholder-shown) + label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            color: #555;
        }

        button {
            margin-top: 25px;
            padding: 12px;
            width: 100%;
            background: #2a73ff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #1d5ee8;
        }

        #log-output {
            margin-top: 30px;
            min-height: 300px;
            width: 80%;
            overflow: auto;
            background: #1e1e1e;
            color: #00ff8c;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            border-radius: 6px;
            border: 1px solid #444;
            resize: both;
            box-sizing: border-box;

            /* Hidden initially */
            display: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div id="credentials-section">
    <h2>API Credentials</h2>
    <div class="input-group">
        <input id="apikey" type="text" required placeholder=" "/>
        <label for="apikey">API Key (required)</label>
    </div>

    <div class="input-group">
        <input id="apisecret" type="password" required placeholder=" "/>
        <label for="apisecret">API Secret (required)</label>
    </div>

    <div class="input-group">
        <input id="mfa_token" type="text" placeholder=" "/>
        <label for="mfa_token">MFA Token (optional)</label>
    </div>

    <div class="input-group">
        <input id="run_token" type="text" required placeholder=" "/>
        <label for="run_token">Run Token (required)</label>
    </div>
    <button id="save-creds">Save and Continue</button>
</div>

<div id="command-section" class="hidden">
    <h2>Run Command</h2>
    <div class="input-group">
        <textarea id="command" placeholder=" "></textarea>
        <label for="command">Enter command</label>
    </div>

    <div class="input-group">
        <input id="timeout" type="number" placeholder=" "/>
        <label for="timeout">Timeout (seconds)</label>
    </div>
    <button id="run-command">Run</button>
    <div id="log-output"></div>
</div>
<script>
    const saveButton = document.getElementById('save-creds');
    const runButton = document.getElementById('run-command');
    const commandSection = document.getElementById('command-section');
    const credentialsSection = document.getElementById('credentials-section');
    const logOutput = document.getElementById('log-output');

    saveButton.addEventListener('click', () => {
        const apikey = document.getElementById('apikey').value.trim();
        const apisecret = document.getElementById('apisecret').value.trim();
        const mfa_token = document.getElementById('mfa_token').value.trim();
        const run_token = document.getElementById('run_token').value.trim();

        if (!apikey || !apisecret || !run_token) {
            alert('API Key, API Secret, and Run Token are required.');
            return;
        }

        localStorage.setItem('apikey', apikey);
        localStorage.setItem('apisecret', apisecret);
        localStorage.setItem('mfa_token', mfa_token);
        localStorage.setItem('run_token', run_token);

        commandSection.classList.remove('hidden');
    });

    runButton.addEventListener('click', async () => {
        const command = document.getElementById('command').value.trim();
        const timeout = parseInt(document.getElementById('timeout').value.trim(), 10);

        if (!command || isNaN(timeout)) {
            alert('Please enter both command and timeout.');
            return;
        }

        const apikey = localStorage.getItem('apikey');
        const apisecret = localStorage.getItem('apisecret');
        const mfa_token = localStorage.getItem('mfa_token');
        const run_token = localStorage.getItem('run_token');

        logOutput.textContent = 'Streaming output...\n';
        logOutput.style.display = 'block';
        credentialsSection.style.display = 'none';

        try {
            const response = await fetch(`${window.location.origin}{{ API_ENDPOINT }}`, {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'api-secret': apisecret,
                    'mfa-code': mfa_token || '',
                    'run-token': run_token,
                    'Authorization': `Bearer ${apikey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command,
                    timeout: timeout,
                    stream: true
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error: ${response.status} - ${errorText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, {stream: true});
                logOutput.textContent += chunk;
                logOutput.scrollTop = logOutput.scrollHeight;
            }

        } catch (err) {
            alert('Network or server error: ' + err.message);
            logOutput.style.display = 'none';
            credentialsSection.style.display = 'block';
        }
    });
</script>
</body>
</html>

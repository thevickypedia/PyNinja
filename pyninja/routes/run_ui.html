<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Command Runner</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button, textarea { margin-top: 10px; display: block; width: 100%; }
    #log-output {
      margin-top: 20px;
      height: 300px;
      overflow-y: auto;
      background: #111;
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #444;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>API Credentials</h2>
  <input id="apikey" type="text" placeholder="API Key (required)">
  <input id="apisecret" type="password" placeholder="API Secret (required)">
  <input id="mfa_token" type="text" placeholder="MFA Token (optional)">
  <input id="run_token" type="text" placeholder="Run Token (required)">
  <button id="save-creds">Save and Continue</button>

  <div id="command-section" class="hidden">
    <h2>Run Command</h2>
    <textarea id="command" placeholder="Enter command here"></textarea>
    <input id="timeout" type="number" placeholder="Timeout (seconds)">
    <button id="run-command">Run</button>

    <div id="log-output"></div>
  </div>

  <script>
    const saveButton = document.getElementById('save-creds');
    const runButton = document.getElementById('run-command');
    const commandSection = document.getElementById('command-section');
    const logOutput = document.getElementById('log-output');

    saveButton.addEventListener('click', () => {
      const apikey = document.getElementById('apikey').value.trim();
      const apisecret = document.getElementById('apisecret').value.trim();
      const mfa_token = document.getElementById('mfa_token').value.trim();
      const run_token = document.getElementById('run_token').value.trim();

      if (!apikey || !apisecret || !run_token) {
        alert('API Key, API Secret, and Run Token are required.');
        return;
      }

      localStorage.setItem('apikey', apikey);
      localStorage.setItem('apisecret', apisecret);
      localStorage.setItem('mfa_token', mfa_token);
      localStorage.setItem('run_token', run_token);

      commandSection.classList.remove('hidden');
    });

    runButton.addEventListener('click', async () => {
      const command = document.getElementById('command').value.trim();
      const timeout = parseInt(document.getElementById('timeout').value.trim(), 10);

      if (!command || isNaN(timeout)) {
        alert('Please enter both command and timeout.');
        return;
      }

      const apikey = localStorage.getItem('apikey');
      const apisecret = localStorage.getItem('apisecret');
      const mfa_token = localStorage.getItem('mfa_token');
      const run_token = localStorage.getItem('run_token');

      logOutput.textContent = 'Streaming output...\n';

      try {
        const response = await fetch(`${window.location.origin}/{{ API_ENDPOINT }}`, {
          method: 'POST',
          headers: {
            'accept': 'application/json',
            'api-secret': apisecret,
            'mfa-code': mfa_token || '',
            'run-token': run_token,
            'Authorization': `Bearer ${apikey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            command: command,
            timeout: timeout,
            stream: true
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          alert(`Error: ${response.status} - ${errorText}`);
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          logOutput.textContent += chunk;
          logOutput.scrollTop = logOutput.scrollHeight;
        }

      } catch (err) {
        alert('Network or server error: ' + err.message);
      }
    });
  </script>
</body>
</html>
